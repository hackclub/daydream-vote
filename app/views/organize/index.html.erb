<div class="main">
  <div class="card big">
    <h1>Organize <%= @event.name %></h1>
    
    <p><strong>Event Management Dashboard</strong></p>
    
    <p>Voting is currently <strong><%= @event.voting_enabled? ? "enabled" : "disabled" %></strong> for this event.</p>

    <%= button_to @event.voting_enabled? ? "Disable Voting" : "Enable Voting", 
        organize_toggle_voting_path(@event), 
        method: :post,
        data: { confirm: @event.voting_enabled? ? "Are you sure you want to disable voting? This will prevent users from casting votes." : "Are you sure you want to enable voting? This will allow users to cast votes." } %>
    
    <div class="organize-tabs">
      <h2>Submitted Projects</h2>
      <p><em>Projects are sorted by number of votes (highest first)</em></p>
    </div>
    
    <% if @visible_projects.any? %>
      <h3>Visible Projects</h3>
      <div class="projects-grid">
        <% @visible_projects.each do |project| %>
          <div class="project-card organize-project">
            <div class="vote-count-large">
              <%= project.votes.count %>
              <span class="vote-label">votes</span>
            </div>
            
            <% if project.thumbnail %>
              <div class="project-image">
                <%= image_tag project.thumbnail, alt: project.title, class: "project-thumbnail" %>
              </div>
            <% end %>
            
            <div class="project-content">
              <div class="project-header">
                <h4><%= project.title %></h4>
                <div class="project-team">
                  by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                </div>
                <span class="status-badge <%= project.aasm_state %>"><%= project.aasm_state.humanize %></span>
              </div>
              
              <div class="project-details">
                <p><%= truncate(project.description, length: 120) %></p>
                
                <div class="project-links">
                  <%= link_to "Play", project.itchio_url, target: "_blank", class: "project-link" %>
                  <%= link_to "Code", project.repo_url, target: "_blank", class: "project-link" %>
                </div>
              </div>
              
              <div class="project-actions">
                <%= link_to "Hide", organize_hide_project_path(@event, project), 
                    method: :patch, 
                    class: "btn btn-danger btn-sm",
                    data: { 
                      confirm: "Are you sure you want to hide this project? It will no longer be visible to voters." 
                    } %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="no-projects">
        <p>No visible projects yet.</p>
      </div>
    <% end %>
    
    <% if @hidden_projects.any? %>
      <h3 style="margin-top: 2rem;">Hidden Projects</h3>
      <div class="projects-grid">
        <% @hidden_projects.each do |project| %>
          <div class="project-card organize-project hidden-project">
            <div class="vote-count-large">
              <%= project.votes.count %>
              <span class="vote-label">votes</span>
            </div>
            
            <% if project.thumbnail %>
              <div class="project-image">
                <%= image_tag project.thumbnail, alt: project.title, class: "project-thumbnail" %>
              </div>
            <% end %>
            
            <div class="project-content">
              <div class="project-header">
                <h4><%= project.title %></h4>
                <div class="project-team">
                  by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                </div>
                <span class="status-badge hidden">Hidden</span>
              </div>
              
              <div class="project-details">
                <p><%= truncate(project.description, length: 120) %></p>
                
                <div class="project-links">
                  <%= link_to "Play", project.itchio_url, target: "_blank", class: "project-link" %>
                  <%= link_to "Code", project.repo_url, target: "_blank", class: "project-link" %>
                </div>
              </div>
              
              <div class="project-actions">
                <%= link_to "Unhide", organize_unhide_project_path(@event, project), 
                    method: :patch, 
                    class: "btn btn-success btn-sm" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <div class="actions" style="margin-top: 2rem;">
      <%= link_to "Back to Event", event_vote_path(@event.name), class: "btn" %>
    </div>
  </div>
</div>

<style>
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .organize-project {
    border: 1px solid #e9ecef;
    border-left: 4px solid #28a745;
    border-radius: 8px;
    padding: 1rem;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
  }
  
  .organize-project.hidden-project {
    border-left-color: #dc3545;
    opacity: 0.7;
  }
  
  .vote-count-large {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
  }
  
  .vote-label {
    font-size: 0.6rem;
    font-weight: normal;
    margin-top: -2px;
  }
  
  .project-image {
    margin-bottom: 1rem;
  }
  
  .project-thumbnail {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .project-header h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    padding-right: 80px; /* Space for vote count */
  }
  
  .project-team {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
  }
  
  .status-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 1rem;
  }
  
  .status-badge.draft {
    background-color: #ffc107;
    color: #000;
  }
  
  .status-badge.submitted {
    background-color: #28a745;
    color: #fff;
  }
  
  .status-badge.hidden {
    background-color: #dc3545;
    color: #fff;
  }
  
  .project-details p {
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 1rem;
  }
  
  .project-links {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .project-link {
    padding: 0.4rem 0.8rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    color: #495057;
    font-size: 0.85rem;
    transition: background-color 0.2s;
  }
  
  .project-link:hover {
    background-color: #e9ecef;
    text-decoration: none;
  }
  
  .project-actions {
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
  }
  
  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-danger {
    background-color: #dc3545;
    color: white;
  }
  
  .btn-success {
    background-color: #28a745;
    color: white;
  }
  
  .btn-sm:hover {
    opacity: 0.9;
    text-decoration: none;
  }
</style>
