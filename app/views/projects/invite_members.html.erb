<% @progress = :invite_team %>

<div class="main">
  <div class="card big">
    <h1 class="invite-title-top">Invite Team Members for</h1>
    <div class="card light">
      <h1 class="invite-title-bottom"><%= @project.title %></h1>
    </div>

    <div class="team-members-list">
      <h3>Team Members</h3>
      
      <div class="members-grid">
        <% 
          # Collect all members and invites
          owner = [{ type: 'owner', email: current_user.email, role: 'Owner', status: current_user.profile_complete? ? 'profile_complete' : 'profile_incomplete' }]
          accepted_members = @project.users.where.not(id: current_user.id).map do |user|
            { 
              type: 'accepted', 
              email: user.email, 
              role: user.creator_positions.find_by(project: @project).role.humanize,
              status: user.profile_complete? ? 'profile_complete' : 'profile_incomplete'
            }
          end
          pending_invites = @project.creator_position_invites.map do |invite|
            { 
              type: 'pending', 
              email: invite.email, 
              role: invite.expired? ? 'Collaborator (expired)' : 'Collaborator (<u>Invite Pending</u>)'.html_safe,
              invite: invite,
              status: 'pending'
            }
          end
          
          all_members = owner + accepted_members + pending_invites
          
          # Always show 3 slots
          3.times do |i|
            member = all_members[i]
        %>
          <div class="card light member-card">
            <% if member %>
              <div class="member-info">
                <div class="member-email">
                  <strong><%= member[:email] %></strong>
                </div>
                <div class="member-role"><%= member[:role] %></div>
              </div>
              <% if member[:type] == 'pending' %>
                <div class="member-actions">
                  <%= form_with url: delete_project_invite_path(member[:invite]), method: :delete, 
                      local: true, data: { turbo: false }, style: "display: inline;" do |form| %>
                    <%= form.submit "Ã—", class: "revoke-btn",
                        onclick: "return confirm('Are you sure you want to revoke this invite?')" %>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="inline-invite-form">
                <%= form_with url: projects_invite_members_path, method: :post, 
                    local: true, data: { turbo: false }, class: "inline-invite" do |form| %>
                  <%= form.email_field :email, 
                      placeholder: "Email of team member ##{i + 1}", 
                      required: true,
                      disabled: @project.submitted?,
                      class: "inline-email-input" %>
                  <%= form.submit "Invite", class: "inline-invite-btn #{"disabled" if @project.submitted?}", disabled: @project.submitted? %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% has_pending_invites = @project.has_pending_invites? %>
      <% incomplete_profiles = !@project.all_members_have_complete_profiles? %>
      <% if has_pending_invites %>
        <p class="pending-notice">
          <strong>Note:</strong> You must wait for all pending invites to be accepted before continuing.
        </p>
      <% elsif incomplete_profiles %>
        <p class="pending-notice">
          <strong>Note:</strong> All team members must complete their profiles before the project can be submitted.
        </p>
      <% end %>
    </div>

    <div
      class="submit-wrapper<%= ' disabled-pending' if has_pending_invites || incomplete_profiles %>"
    >
      <%= link_to "Continue", review_project_path, class: "submit-button-elem #{"disabled" if @project.submitted? || has_pending_invites || incomplete_profiles}" %>
      <img
        src="/button-clouds.svg" 
        alt="" 
        class="submit-clouds"
      >
    </div>
  </div>
</div>