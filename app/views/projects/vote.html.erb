<% @progress = :vote %>

<div class="main">
  <div class="card big">

    <h1>Vote!</h1>

    <% unless @event.voting_enabled? %>
      <div class="alert alert-info">
        <p><strong>Voting is not turned on by the organizers yet</strong></p>
        <p><%= @voting_disabled_message %></p>
      </div>
    <% elsif !signed_in? %>
      <div class="alert alert-info">
        <p><strong>Sign in to vote</strong></p>
        <p>You must be signed in and have a submitted project to vote.</p>
        <%= link_to "Sign in", new_session_path, class: "btn btn-primary" %>
      </div>
    <% else %>
      <p><strong>Choose the top 3 projects to award prizes</strong></p>

      <% votes = @projects.map(&:votes).map(&:count).sum %>
      <p><em><%= votes %> <%= votes == 1 ? "vote has" : "votes have" %> been cast so far.</em></p>

      <div class="voting-instructions">
        <p>Vote for the projects you think deserve recognition. You can vote for up to 3 projects.</p>
        <p><em>Note: You cannot vote for projects you've contributed to.</em></p>
      </div>
    <% end %>

    <% if @projects.any? %>
      <% if @event.voting_enabled? && signed_in? %>
        <%= form_for :project_votes, url: event_make_vote_selection_path(@event.name), method: :post, local: true, data: { turbo: false } do |form| %>
      <% end %>
      
      <div class="projects-list">
        <% @projects.each do |project| %>
          <div class="project-card">
            <% if project.thumbnail %>
              <div class="project-image">
                <%= image_tag project.thumbnail, alt: project.title, class: "project-thumbnail" %>
              </div>
            <% end %>
            
            <div class="project-content">
              <div class="project-header">
                <h3><%= project.title %></h3>
                <div class="project-team">
                  by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                </div>
              </div>
            
            <div class="project-details">
              <p><%= project.description %></p>
              
              <% if @event.voting_enabled? %>
                <div class="project-links">
                  <%= link_to "Play on Itch.io", project.itchio_url, target: "_blank", class: "project-link" %>
                  <%= link_to "View Code", project.repo_url, target: "_blank", class: "project-link" %>
                </div>
              <% end %>
            </div>
            
              <% if @event.voting_enabled? && signed_in? %>
                <div class="voting-actions">
                  <label class="vote-checkbox">
                    <%= form.check_box project.id, checked: project.in?(@votes.map(&:project)) %>
                    Vote for this project
                  </label>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      
      <% if @event.voting_enabled? && signed_in? %>
        <div class="voting-form">
          <form action="#" method="post" data-turbo="false">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <button type="submit" class="btn btn-primary">Submit Votes</button>
          </form>
        </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="no-projects">
        <p>No projects available for voting at this time.</p>
        <p>Either no other participants have submitted projects yet, or you're the only participant at your event.</p>
      </div>
    <% end %>

    <div class="actions">
      <%= link_to "Back to Team Setup", projects_invite_members_path, class: "btn" %>
    </div>
  </div>
</div>

<style>
  .project-card {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .project-image {
    flex-shrink: 0;
  }
  
  .project-thumbnail {
    width: 200px;
    height: 133px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .project-content {
    flex: 1;
  }
  
  .voting-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
  }
  
  .vote-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    cursor: pointer;
  }
  
  .vote-checkbox input[type="checkbox"] {
    transform: scale(1.2);
  }
</style>