<% @progress = :vote %>

<div class="main">
  <div class="card big" style="width: 100%">

    <h1>Vote!</h1>

    <% if !@event.voting_enabled? %>
      <% votes_exist = Vote.joins(:project).where(projects: { attending_event: @event }).exists? %>
      <div class="alert alert-info">
        <% if votes_exist %>
          <p><strong>Voting has ended</strong></p>
        <% else %>
          <p><strong>Voting is not turned on by the organizers yet</strong></p>
          <p><%= @voting_disabled_message %></p>
        <% end %>
      </div>
    <% elsif !signed_in? %>
      <div class="alert alert-info">
        <p>You must be signed in and have a submitted project to vote.</p>
      </div>
    <% else %>
      <p><strong>Choose the top 3 projects to award prizes</strong></p>

      <% votes = @projects.map(&:votes).map(&:count).sum %>
      <p><em><%= votes %> <%= votes == 1 ? "vote has" : "votes have" %> been cast so far.</em></p>

      <div class="voting-instructions">
        <p>Vote for the projects you think deserve recognition. You can vote for up to 3 projects.</p>
        <p><em>Note: You cannot vote for projects you've contributed to.</em></p>
      </div>
    <% end %>

    <% if @projects.any? %>
      <% if @event.voting_enabled? && signed_in? %>
        <%= form_for :project_votes, url: event_make_vote_selection_path(@event.name), method: :post, local: true, data: { turbo: false } do |form| %>
          <div class="projects-grid">
            <% @projects.each do |project| %>
              <div class="card light game-card-wrapper">
                <div class="card light game-card">
                  <div class="game-image">
                    <% if project.thumbnail %>
                      <%= image_tag project.thumbnail, alt: project.title, class: "game-image-cover" %>
                    <% end %>
                  </div>
                  <div class="game-info">
                    <h2><%= project.title %></h2>
                    <div class="game-byline">
                      by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                    </div>
                    <p><%= project.description %></p>
                  </div>
                  
                  <div class="game-card-buttons">
                    <div class="submit-wrapper review-button">
                      <%= link_to "View on Itch.io", project.itchio_url, target: "_blank", class: "submit-button-elem" %>
                      <img src="/button-clouds.svg" alt="" class="submit-clouds">
                    </div>
                    
                    <div class="submit-wrapper review-button">
                      <%= link_to "View Git Repository", project.repo_url, target: "_blank", class: "submit-button-elem" %>
                      <img src="/button-clouds.svg" alt="" class="submit-clouds">
                    </div>
                  </div>
                </div>
                
                <div class="project-vote-action">
                  <label class="vote-checkbox">
                    <%= form.check_box project.id, checked: project.in?(@votes.map(&:project)) %>
                    Vote for this project
                  </label>
                </div>
              </div>
            <% end %>
          </div>
          
          <div class="actions" style="margin-top: 2rem;">
            <div class="submit-wrapper">
              <button type="submit" class="submit-button-elem" onclick="return confirm('Are you sure you want to submit your votes? This cannot be undone.')">Submit Votes</button>
              <img src="/button-clouds.svg" alt="" class="submit-clouds">
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="projects-grid">
          <% @projects.each do |project| %>
            <div class="card light game-card-wrapper">
              <div class="card light game-card">
                <div class="game-image">
                  <% if project.thumbnail %>
                    <%= image_tag project.thumbnail, alt: project.title, class: "game-image-cover" %>
                  <% end %>
                </div>
                <div class="game-info">
                  <h2><%= project.title %></h2>
                  <div class="game-byline">
                    by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                  </div>
                  <p><%= project.description %></p>
                </div>
                
                <% if @event.voting_enabled? %>
                  <div class="game-card-buttons">
                    <div class="submit-wrapper review-button">
                      <%= link_to "View on Itch.io", project.itchio_url, target: "_blank", class: "submit-button-elem" %>
                      <img src="/button-clouds.svg" alt="" class="submit-clouds">
                    </div>
                    
                    <div class="submit-wrapper review-button">
                      <%= link_to "View Git Repository", project.repo_url, target: "_blank", class: "submit-button-elem" %>
                      <img src="/button-clouds.svg" alt="" class="submit-clouds">
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <% unless @event.voting_enabled? && signed_in? %>
      <div class="actions" style="margin-top: 2rem;">
        <div class="submit-wrapper">
          <% if !signed_in? %>
            <%= link_to "Sign in", new_session_path, class: "submit-button-elem" %>
          <% else %>
            <%= link_to "Back to Team Setup", projects_invite_members_path, class: "submit-button-elem" %>
          <% end %>
          <img src="/button-clouds.svg" alt="" class="submit-clouds">
        </div>
      </div>
    <% end %>
  </div>
</div>