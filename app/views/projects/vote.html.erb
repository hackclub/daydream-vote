<% @progress = :vote %>

<div class="main">
  <div class="card big">

    <h1>Vote!</h1>

    <% unless @event.voting_enabled? %>
      <div class="alert alert-info">
        <p><strong>Voting is not turned on by the organizers yet</strong></p>
        <p><%= @voting_disabled_message %></p>
      </div>
    <% else %>
      <p><strong>Choose the top 3 projects to award prizes</strong></p>

      <% votes = @projects.map(&:votes).map(&:count).sum %>
      <p><em><%= votes %> <%= votes == 1 ? "vote has" : "votes have" %> been cast so far.</em></p>

      <div class="voting-instructions">
        <p>Vote for the projects you think deserve recognition. You can vote for up to 3 projects.</p>
        <p><em>Note: You cannot vote for projects you've contributed to.</em></p>
      </div>

      <% if @projects.any? %>
      <%= form_for :project_votes, url: event_make_vote_selection_path(@event.name), method: :post, local: true, data: { turbo: false } do |form| %>
        <div class="projects-list">
          <% @projects.each do |project| %>
          
            <div class="project-card">
              <div class="project-header">
                <h3><%= project.title %></h3>
                <div class="project-team">
                  by <%= project.users.map { |user| user&.profile_datum&.first_name || user&.email }.flatten.join(", ") %>
                </div>
              </div>
              
              <div class="project-details">
                <p><%= project.description %></p>
                
                <div class="project-links">
                  <%= link_to "Play on Itch.io", project.itchio_url, target: "_blank", class: "project-link" %>
                  <%= link_to "View Code", project.repo_url, target: "_blank", class: "project-link" %>
                </div>
              </div>
              
              <div class="voting-actions">
                <label class="vote-checkbox">
                  <%= form.check_box project.id, checked: project.in?(@votes.map(&:project)) %>
                  Vote for this project
                </label>
              </div>
            </div>
          <% end %>
        </div>
        
        <div class="voting-form">
          <form action="#" method="post" data-turbo="false">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <button type="submit" class="btn btn-primary">Submit Votes</button>
          </form>
        </div>
        <% end %>
      <% else %>
        <div class="no-projects">
          <p>No projects available for voting at this time.</p>
          <p>Either no other participants have submitted projects yet, or you're the only participant at your event.</p>
        </div>
      <% end %>
    <% end %>

    <div class="actions">
      <%= link_to "Back to Team Setup", projects_invite_members_path, class: "btn" %>
    </div>
  </div>
</div>